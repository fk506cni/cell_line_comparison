---
title: "137PCA_renormalization"
author: "fkeita"
date: "2017/8/18"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE,cache.lazy = FALSE, echo=TRUE)
# source("http://bioconductor.org/biocLite.R")
# BiocManager::install("GEOquery")
# BiocManager::install("RobLoxBioC")
require("stringr")
require("MASS")
require("ggplot2")

q_value_cuttoff <- 0.0001
fkac <- "fkeita@kuhp.kyoto-u.ac.jp"

require(extrafont)
loadfonts(quiet = T)

#biocLite("GEOquery")
# BiocManager::install("GEOquery")
require(GEOquery)

set.seed("20170821")
```

```{r}
theme_ggh <- function(font.size=10,legend.position = "none") {
            theme(axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            axis.title = element_blank(),
            axis.line = element_blank(),
            axis.ticks = element_blank(),
            plot.title = element_blank(),
            panel.grid = element_blank(),
            panel.border = element_blank(),
            panel.spacing = element_blank(),
            panel.background = element_blank(),
            plot.background = element_blank(),
            plot.margin = unit(c(0,0,0,0),"cm"),
            text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
            legend.position = "none")
}
```

I will re lanalyssis PCA data.  
PCA is Primary cell atlas.  


##get starting data
```{r}
#downloader::download(url = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE49nnn/GSE49910/matrix/GSE49910_series_matrix.txt.gz",
#                     destfile="./metadata/gse49910.gz")
#gunzip("./metadata/gse49910.gz")

sampleGSM <- read.table(file = "./metadata/gse49910",header = F,sep = "\t",stringsAsFactors = F,skip = 28,check.names = F,quote = "",nrows = 667)
sampleGSM$gsm_id <- str_extract(sampleGSM$V2,pattern = "GSM[0-9]*")

```

##get annotations
```{r message=FALSE, warning=FALSE}
#downloader::download(url = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE49nnn/GSE49910/soft/GSE49910_family.soft.gz",
#                      destfile="./GSE49910_family.soft.gz")
gsm49910 <- getGEO(filename = "./GSE49910_family.soft.gz")
#gsm49910@header

pca_GSM <- gsm49910@header$relation
pca_GSM <- pca_GSM[-length(pca_GSM)]
pca_GSM <- str_extract(pca_GSM, "GSM[0-9]*")
pca_GSM <- c(pca_GSM, gsm49910@header$sample_id)
rm(gsm49910)
gsm_annot <- list()
for(i in pca_GSM){
   gsm_i <- getGEO(GEO = i,destdir = "./tempdata")
   gsm_annot <- c(gsm_annot, list(gsm_i@header))
}
names(gsm_annot) <- pca_GSM

```


##aboud description
```{r}
#gsm_annot$GSM347920

#annot <- base::unlist(gsm_annot,recursive = T,use.names = T)

#keyname <- "title"

#gsm_annot[[2]][keyname]


list_1nest <- function(nested_list){
  nested_names <- c()
  for(i in nested_list){
    nested_names <- c(nested_names, names(i))
  }
  nested_names <- nested_names[!duplicated(nested_names)]
  
  #print(paste(length(nested_names)," is number of nested_names"))
  key_vector <- function(list, keyname){
    result_vector <- c()
    result_name <- names(list)
    for(i in list){
      #print(i[keyname])
      result_word <- as.character(i[keyname])
      result_vector <- c(result_vector, result_word)
    }
    names(result_vector) <- result_name
    return(result_vector)
  }
  
  result_df <- NULL
  for(j in nested_names){
    #print(paste(j, "is now vectorized..."))
    result_vector_j <- key_vector(nested_list, j)
    result_df <- cbind(result_df, result_vector_j)
  }
  colnames(result_df) <- nested_names
  result_df <- as.data.frame(result_df)
  return(result_df)
}

df_fac2chr <- function(df){
  df <- as.data.frame(df)
  for(i in c(1:ncol(df))){
    df[,i] <- as.character(df[,i])
  }
  return(df)
}


result_df <- list_1nest(gsm_annot)
result_df <- df_fac2chr(result_df)


wanted_df <- cbind(result_df$geo_accession,
            result_df$characteristics_ch1,
            result_df$source_name_ch1,
            result_df$title)
write.table(x = wanted_df,
            file = "wanted.csv",sep = ",",
            row.names = T,col.names = NA)



#result_df$celdata <- paste(result_df$geo_accession, ".CEL",sep = "")
```


##get raw data
```{r}
# getGEOSuppFiles("GSE49910",makeDirectory = F,baseDir = "./celfiles")
# untar(tarfile = "./celfiles/GSE49910_RAW.tar",exdir = "./celfiles/")
# 
# 
# for(i in c(1:nrow(result_df))){
#   getGEOSuppFiles(GEO = result_df$geo_accession[i],makeDirectory = F,baseDir = "./celfiles")
# }

```


##DL chekc
```{r}
cels <- list.files(path = "./celfiles",pattern = ".CEL|.cel.gz",full.names = T)
liver_cels <- list.files(path = "./celfiles",pattern = "liver.CEL",full.names = T)

gsm_cels <- cels[str_detect(cels, pattern = "GSM[0-9]*")]
gsm_cels <- str_extract(gsm_cels, pattern = "GSM[0-9]*")


re_download <- result_df[!result_df$geo_accession %in% gsm_cels,]$geo_accession
#for(i in c(1:length(re_download))){
#  getGEOSuppFiles(GEO = re_download[i],makeDirectory = F,baseDir = "./celfiles")
#}


```

##each normalization by MAS5
```{r echo=FALSE}
# require(affy)
# require(doParallel)
# require(foreach)
# start <- Sys.time()
# cl <- makeCluster(8)
# registerDoParallel(cl)
# 
# mas5_4each <- foreach(i=c(1:length(cels)),.export = "cels",
#                     .combine = "cbind",.packages = "affy",.verbose = F) %dopar% {
#   mas5_i <- exprs(mas5(ReadAffy(filenames = cels[i])))
#   mas5_i
# }
# stopCluster(cl)
# finish <- Sys.time()
# time_foreach <- finish - start
# time_foreach
# 

```


save and load
```{r}
f_4out <- "mas5_4each.rda"

# save(mas5_4each, file="mas5_4each.rda")
# rm(mas5_4each)

load(f_4out)

```


##each normalization by Rob
```{r}
# require(RobLoxBioC)
#rob5 <- exprs(robloxbioc(ReadAffy(filenames = cels5)))
# cels5 <- sample(cels,10, replace = F)
# start <- Sys.time()
# robeach <- NULL
# for(i in c(1:length(cels5))){
#   print(cels5[i])
#   rob_i <- exprs(robloxbioc(ReadAffy(filenames = cels5[i])))
#   robeach <- cbind(robeach, rob_i)
# }
# colnames(robeach) <- cels
# finish <- Sys.time()
# time_robeach <- c(finish,start)
# time_robeach[1] - time_robeach[2]

# require(doParallel)
# require(foreach)
# start <- Sys.time()
# cl <- makeCluster(8)
# registerDoParallel(cl)
# 
# rob_4each <- foreach(i=c(1:length(cels)),
#                     .combine = "cbind",.packages = c("affy","RobLoxBioC")) %dopar% {
#   rob_i <- exprs(robloxbioc(ReadAffy(filenames = cels[i])))
#   rob_i
# }
# stopCluster(cl)
# finish <- Sys.time()
# time_robforeach <- c(finish,start)
# time_robforeach[1] - time_robforeach[2]

# detach("package:GEOquery", unload=TRUE)
# detach("package:RobLoxBioC", unload=TRUE)
# detach("package:affy", unload=TRUE)
# detach("package:Biobase", unload=TRUE)
# detach("package:BiocGenerics", unload=TRUE)
# detach("package:doParallel", unload=TRUE)
# detach("package:foreach", unload=TRUE)

```

#distribution check
```{r}
summarizer <- function(x){
  base_mean <- function(x){base::mean(x)}
  stats_median <- function(x){stats::median(x)}
  stats_var <- function(x){stats::var(x)}
  stats_mad <- function(x){stats::mad(x)}
  
  lin_mean <- apply(x,1,base_mean)
  lin_median <- apply(x,1,stats_median)
  lin_var <- apply(x,1,stats_var)
  lin_mad <- apply(x,1,stats_mad)
  
  log2x <- log(x)
  log2_mean <- apply(log2x,1,base_mean)
  log2_median <- apply(log2x,1,stats_median)
  log2_var <- apply(log2x, 1, stats_var)
  log2_mad <- apply(log2x, 1, stats_mad)
  
  result <- data.frame(lin_mean=lin_mean,
                       lin_mean_rank =rank(lin_mean),
                       lin_median=lin_median,
                       lin_median_rank =rank(lin_median),
                       lin_var=lin_var,
                       lin_var_rank=rank(lin_var),
                       lin_mad=lin_mad,
                       lin_mad_rank=rank(lin_mad),
                       log2_mean=log2_mean,
                       log2_mean_rank =rank(log2_mean),
                       log2_median=log2_median,
                       log2_median_rank=rank(log2_median),
                       log2_var=log2_var,
                       log2_var_rank=rank(log2_var),
                       log2_mad=log2_mad,
                       log2_mad_rank=rank(log2_mad))
  return(result)
}

mas5summary <- summarizer(mas5_4each)

plot(mas5summary$lin_mean, mas5summary$lin_var)


#x <- mas5summary$lin_mean
#y <- mas5summary$lin_var

dist_check <- function(x,y,slope=NULL){
  require(ggplot2)
  if(is.null(slope)){
    slope <- 1
  }
  df <- data.frame(x, y)
  df_label <- c(deparse(substitute(x)),deparse(substitute(y))) 
  colnames(df) <- c("x", "y")
  p <- ggplot()+
    geom_abline(slope = slope, intercept = 0,size=1,colour="red")+
    geom_point(data = df,mapping = aes(x=x,y=y),size=0.1)+
    xlab(df_label[1])+ylab(df_label[2])+
    theme_classic()+
    theme(aspect.ratio = 1)
  p
}

dist_check(mas5summary$lin_mean, mas5summary$lin_var)
dist_check(mas5summary$log2_mean,mas5summary$log2_var)
dist_check(mas5summary$log2_median,mas5summary$log2_mad)

# robsummary <- summarizer(rob_4each)
# dist_check(robsummary$lin_mean, robsummary$lin_var)
# dist_check(robsummary$log2_mean,robsummary$log2_var)
# dist_check(robsummary$log2_median,robsummary$log2_mad)
```


##log2 conversion
```{r}
mas5lg2 <- log2(mas5_4each)
truehist(mas5lg2)

#mas5lg2 <- mas5lg2[(mas5summary$lin_median_rank / nrow(mas5summary)) > 3/4,]
dim(mas5lg2)
truehist(mas5lg2)


# roblg2 <- log2(rob_4each) 
# truehist(roblg2)
```



##name_conversion matrix
```{r}
require(stringr)
rowname_cands <- cels
rowname_cands <- str_replace(rowname_cands,"\\./celfiles/","")
data_colname <- rowname_cands
rowname_cands <- str_replace(rowname_cands, "\\.gz","")
rowname_cands <- str_replace(rowname_cands, "\\.CEL|\\.cel","")
head(rowname_cands)
tail(rowname_cands)

#rowname_cands

for(i in c(1:length(rowname_cands))){
  if(str_detect(rowname_cands[i],"^[ABC]")){
    rowname_cands[i] <- rowname_cands[i]
  }
  else if(str_detect(rowname_cands[i], "^GSM")){
    rowname_cands[i] <- str_extract(rowname_cands[i], "^GSM[0-9]*")
  }
  else{
    cat("unknown condition")
  }
}

conv_mat <- data.frame(filename=cels,data_colname=data_colname,id=rowname_cands,stringsAsFactors = F)
conv_mat <- merge(conv_mat, result_df,by.x = "id", by.y = "geo_accession",sort = F,all.x = T)

conv_mat$title <- ifelse(test = is.na(conv_mat$title),yes = "",no = conv_mat$title)
conv_mat$source_name_ch1 <- ifelse(test = is.na(conv_mat$source_name_ch1),
                                   yes = "",no = conv_mat$source_name_ch1)
conv_mat$characteristics_ch1 <- ifelse(test = is.na(conv_mat$characteristics_ch1),
                                       yes = "",no = conv_mat$characteristics_ch1)
conv_mat$colname_tag <- base::paste(conv_mat$id, conv_mat$title)



convertvector <- function(inputvector, matrix_in_out){
  colnames(matrix_in_out) <- c("in", "out")
  if (sum(inputvector %in% matrix_in_out[["in"]]) != length(inputvector)) {
    return("all inputvectors must be inclued matrix in")
  }
  else if(sum(duplicated(matrix_in_out[["in"]])!=0)){
    return("input vector must be unique")
  }
  else{
      output_vector <- c(NULL)
      for (i in inputvector){
          i_output <- matrix_in_out[matrix_in_out[,1]==i,2]
          i_output <- as.character(i_output)
          output_vector <- c(output_vector, i_output)
      }
      return(output_vector)
  }
}


# base::colnames(mas5lg2) <- convertvector(inputvector = base::colnames(mas5lg2),
#                                          matrix_in_out = data.frame(conv_mat$data_colname,
#                                                                     conv_mat$colname_tag))
# 
# base::colnames(roblg2) <- convertvector(inputvector = base::colnames(roblg2),
#                                          matrix_in_out = data.frame(conv_mat$data_colname,
#                                                                     conv_mat$colname_tag))

```

##categorizer
for interpretation of cluster
```{r}

categ <- list(Tcell=c("T_cell","T cell","T cells","CD4 cells","Treg","t_cell","Effector memory","Central memory","Naive, donor"),
              Bcell=c("B-cells","B cells","B cell"),
              Mono_Macro = c("Monocyte","monocytes","monopcytes","Peripheral blood from healthy human donor","macrophages","Macrophages"),
              Erythroblast = c("Erythroblast"),
              BM_HSC =c("Bone marrow & progenitors","Myelocytes","MEP cells","GMP cells","CMP cells",
                        "HSC","Human composite bone marrow","peripheral blood, prior"),
              Neutrophils=c("Neutrophils","neutrophils","PMN"),
              Gametes=c("Sperm","Oocytes","oocytes"),
              Centros=c("centrocyte","centroblast"),
              NKcells=c("NK cells","Natural killer cells","Natural Killer cells "),
              Dendritic_cells=c("Dendritic cells","dendritic cells","MDDC","DCs","Dcs"),
              MSC=c("-defrived mesenchymal stem cells","BM MSC","BM-MSC","cell type: mesenchymal stem cells","derived mesenchymal stem cells"),
              Plt=c("platelet"),
              SMC=c("smooth muscle cells","Smooth Muscle Cells","SMCs","smooth muscle cell"),
              Neuron=c("Nerve","astrocytes"),
              Endocrine=c("adrenal medulla"),
              Keratinocytes=c("keratinocytes"),
              Hepatocytes=c("hepatocyte"),
              Bone_etc=c("osteoblast","chondrocyte","DPSCs","adipocyte","adipose stem cell"),
              Vascular=c("lymphatic endothelial cells","HUVEC","Vein ECs","blood vessel endothelial cell","HMVEC","cell type: Endothelial cells"),
              Fibroblasts=c("Foreskin Cells","normal fibroblast","cell type: fibroblast","Human Fibroblast cells","PDB fibroblasts","fibroblasts_","Fibroblasts uninfected","Fibroblasts infected"),
              Epitel=c("bronchial epithelial cells"),
              Bladder=c("bladder"),
              ES_iPS=c("ESC","iPS","hIPSC","ES cell","Human Embryonic Stem Cells","embryonic stem cells")
              )

categ2 <- list(Blood_cell=c("T_cell","T cell","T cells","CD4 cells","Treg","t_cell","Effector memory","Central memory","Naive, donor","B-cells","B cells","B cell","Monocyte","monocytes","monopcytes","Peripheral blood from healthy human donor","macrophages","Macrophages","Erythroblast","Bone marrow & progenitors","Myelocytes","MEP cells","GMP cells","CMP cells","HSC","Human composite bone marrow","peripheral blood, prior","Neutrophils","neutrophils","PMN","centrocyte","centroblast","platelet","NK cells","Natural killer cells","Natural Killer cells ","Dendritic cells","dendritic cells","MDDC","DCs","Dcs"),
              MSC=c("-defrived mesenchymal stem cells","BM MSC","BM-MSC","cell type: mesenchymal stem cells","derived mesenchymal stem cells"),
              SMC=c("smooth muscle cells","Smooth Muscle Cells","SMCs","smooth muscle cell"),
              Neuro_endo=c("Nerve","astrocytes","adrenal medulla"),
              Hepatocytes=c("hepatocyte"),
              Bone_soft=c("osteoblast","chondrocyte","DPSCs","adipocyte","adipose stem cell"),
              Vascular=c("lymphatic endothelial cells","HUVEC","Vein ECs","blood vessel endothelial cell","HMVEC","cell type: Endothelial cells"),
              Fibroblasts=c("Foreskin Cells","normal fibroblast","cell type: fibroblast","Human Fibroblast cells","PDB fibroblasts","fibroblasts_","Fibroblasts uninfected","Fibroblasts infected"),
              Other=c("bronchial epithelial cells","bladder","keratinocytes"),
              ES_iPS_germ=c("ESC","iPS","hIPSC","ES cell","Human Embryonic Stem Cells","embryonic stem cells","Sperm","Oocytes","oocytes")
              )



#annotation_df <- data.frame(conv_mat$characteristics_ch1, conv_mat$source_name_ch1, conv_mat$title,stringsAsFactors = F)
#dictionaly_list <- categ

categolizer <- function(annotation_df, dictionaly_list){
  require(stringr)
  result_vector <- c()
  category_names <- names(dictionaly_list)

  vector_keyword <- function(search_vector, keyword_vector){
    vector_boolen <- c()
    for(j in c(1:length(search_vector))){
      for(k in c(1:length(keyword_vector))){
        boolen_temp1 <- str_detect(string = search_vector[j], keyword_vector[k])
        vector_boolen <- c(vector_boolen, boolen_temp1)
      }
    }
    return(sum(vector_boolen)!=0)
  }
  
  for(i in c(1:nrow(annotation_df))){
    annotation_boolen_temp <- c()
    for(l in c(1:length(category_names))){
      boolen_temp2 <- vector_keyword(search_vector = annotation_df[i,],
                                     keyword_vector = dictionaly_list[[l]])
      annotation_boolen_temp <- c(annotation_boolen_temp, boolen_temp2)
    }
    category_words_i <- category_names[annotation_boolen_temp]
    category_words_i <- paste(category_words_i,sep = "_",collapse = "_")
    result_vector <- c(result_vector,category_words_i)
  }
  return(result_vector)
}
```

##categolization
```{r}
conv_mat$category <- categolizer(annotation_df = data.frame(conv_mat$characteristics_ch1,
                                                   conv_mat$source_name_ch1,
                                                   conv_mat$title,stringsAsFactors = F),
                        dictionaly_list = categ2)

conv_mat$sample_tag <- paste(conv_mat$category, conv_mat$id, sep = "_")

conv_mat$category <- ifelse(conv_mat$category=="",str_extract(conv_mat$colname_tag,"^[ABC]"),conv_mat$category)

# openxlsx::write.xlsx(x = conv_mat,file = "./conv_mat.xlsx")
```

##colnames of matrix
```{r}
#dim(mas5lg2)
#colnames(mas5lg2)
#conv_mat$id

colnames_temp <- colnames(mas5lg2)
colnames_temp <- str_replace_all(colnames_temp,pattern = "\\.cel\\.gz","")
colnames_temp <- str_replace_all(colnames_temp,pattern = "\\.cel|\\.CEL","")

colnametemp <- for(i in c(1:length(colnames_temp))){
  if(str_detect(colnames_temp[i],"^[ABC]")){
    colnames_temp[i] <- colnames_temp[i]
  }
  else if(str_detect(colnames_temp[i], "^GSM")){
    colnames_temp[i] <- str_extract(colnames_temp[i], "^GSM[0-9]*")
  }
  else{
    print("unknown condition")
  }
}

#colnames_temp
#conv_mat$id
#colnames_temp[!colnames_temp %in% conv_mat$id]

#matrix_in_out = data.frame(conv_mat$id,conv_mat$sample_tag)


colnames_temp <- convertvector(inputvector = colnames_temp,
                                         matrix_in_out = data.frame(conv_mat$id,                                                                    conv_mat$sample_tag,stringsAsFactors = F))

colnames(mas5lg2) <- colnames_temp
# colnames(roblg2) <- colnames_temp
rm(colnames_temp)
```


##read annotation from R87
```{r}
annot <- read.table(file = "2Garray.annot_2.txt",header = T,sep = "\t",stringsAsFactors = F)
annot <- annot[sort.list(annot$avg_sub,decreasing = F),]
deg <- annot[annot$q.value < q_value_cuttoff,]

```

##other mission
```{r}
other_genes <- c("CDH2","VIM","FN1")
others <- annot[annot$Gene.Symbol %in% other_genes,]
write.table(x = others, file = "genesExp_3_fromR137.txt",sep = "\t",row.names = T,col.names =NA)
```

##reference sort
```{r}
ref_sort <- function(sort_vector, ref_vector){
  result_vector <- c()
  for(i in c(1:length(ref_vector))){
    index_i <- which(sort_vector==ref_vector[i])
    result_vector <- c(result_vector, index_i)
  }
  return(result_vector)
}

m <- mas5lg2[rownames(mas5lg2) %in% deg$Row.names,]
m <- m[ref_sort(sort_vector =  rownames(m),ref_vector = deg$Row.names),]
m <- m[,ref_sort(sort_vector = colnames(m),ref_vector = conv_mat$sample_tag)]

colslider <- conv_mat$category
rowslider <- deg$gene_cluster
```


##ggheat
```{r}
# df = t(m)
# colslider=rowslider
# rowslider=colslider
# ColV = T
# colname_label = F
# font.size = 1
#                    clst_method="average"
#                    dist_method="spearman"

ggheat <- function(df,
                   clst_method="average",
                   dist_method="spearman",
                   colslider, rowslider,
                   ColV=T, RowV=T,
                   colname_label=T, rowname_label=T,
                   colangle=45, rowangle=45,
                   colours=c("blue", "white", "red"),
                   key.axis.fontsize=12,
                   main="title",
                   add_p=NULL,
                   lmat=NULL,
                   lhei=NULL,lwid=NULL,
                   font.size=10,
                   rowslider_palette=NULL,
                   col_pallete=NULL){
  require(ggplot2)
  require(reshape2)##for melting
  require(grid)
  require(gridExtra)
  require(ggdendro)
  require(scales)
  ##common theme function
  theme_ggh <- function(font.size=10,legend.position = "none") {
              theme(axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              axis.title = element_blank(),
              axis.line = element_blank(),
              axis.ticks = element_blank(),
              plot.title = element_blank(),
              panel.grid = element_blank(),
              panel.border = element_blank(),
              panel.spacing = element_blank(),
              panel.background = element_blank(),
              plot.background = element_blank(),
              plot.margin = unit(c(0,0,0,0),"cm"),
              text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
              legend.position = "none"
)
  }
  
  ##blank grid for plotting blank
  blank_grid <- grid.rect(gp=gpar(col="white"))

  df <- as.data.frame(df)
  
  ##clustering if needed
  cluster_data <- list()
  if(ColV==T){
     dist_x <- as.dist(1-cor(as.matrix(df),method = dist_method))
     clst_x <- hclust(dist_x,method = clst_method)
     df <- df[,clst_x$order]
     colslider <- colslider[clst_x$order]
     cluster_data <- append(cluster_data, list(clst_x))
  }
  
  if(RowV==T){
     dist_y <- as.dist(1-cor(as.matrix(t(df)),method = dist_method))
     clst_y <- hclust(dist_y,method = clst_method)
     df <- df[clst_y$order,]
     rowslider <- rowslider[clst_y$order]
     cluster_data <- append(cluster_data, list(clst_y))
  }
  
  ##matrix prepareation
  colname <- colnames(df)
  colname <- data.frame(text=colname, x=c(1:length(colname)),colslider=colslider)
  colnames(df) <- c(1:ncol(df))
  
  rowname <- rownames(df)
  rowname <- data.frame(text=rowname, y=c(1:length(rowname)),rowslider=rowslider)
  rownames(df) <- c(1:nrow(df))
  
  tiledata <- melt(as.matrix(df))
  
  ##heatmap is p1
  p1 <- ggplot()+
        geom_tile(data = tiledata, mapping = aes(x=Var2, y = Var1, fill=value))+
        scale_x_continuous(expand=c(0,0))+ 
        scale_y_continuous(expand=c(0,0))+
        scale_fill_gradient2(low = colours[1],mid = colours[2],high = colours[3],midpoint = (max(tiledata$value)+min(tiledata$value))/2)+
        guides(fill=F)+
        theme_ggh()
  #p1

  ##colslider is cols
  cols <- ggplot()+
          geom_tile(data=colname,aes(x=x,y=0,fill=colslider))+
          scale_x_continuous(expand=c(0,0))+ 
          scale_y_continuous(expand=c(0,0))+
          theme_ggh()
##          scale_fill_identity(guide = "legend")+
          
  #cols
  
  
  if(!is.null(rowslider_palette)){
    add_fill <- function(){return(scale_fill_manual(values = rowslider_palette,name="category"))}
  }else{
    add_fill <- function(){return(scale_fill_discrete(name="category"))}
  }
  ##rowslider is rows
  rows <- ggplot()+
          geom_tile(data=rowname,aes(x=0,y=y,fill=rowslider))+
          scale_x_continuous(expand=c(0,0))+ 
          scale_y_continuous(expand=c(0,0))+
          add_fill()+
          theme(legend.text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
                legend.title =element_text(family = "Arial",size=font.size+2,lineheight = 0.7))
  
  rows_grob <- ggplot_gtable(ggplot_build(rows))
  id.legend <- which(sapply(rows_grob$grobs, function(x) x$name)=="guide-box")
  rows_legend <- rows_grob$grobs[[id.legend]]
  
  rows <- ggplot()+
          geom_tile(data=rowname,aes(x=0,y=y,fill=rowslider))+
          scale_x_continuous(expand=c(0,0))+ 
          scale_y_continuous(expand=c(0,0))+
          add_fill()+
          theme_ggh()
  #rows
  
  ##col dendrogram if needed
  if(ColV==T){
    coldend <- as.dendrogram(clst_x)
    #plot(coldend)
    coldend <- segment(dendro_data(coldend))
    cold <- ggplot()+
            geom_segment(data=coldend,aes(x=x, y=y, xend=xend, yend=yend))+
            scale_x_continuous(expand=c(0,0),limits = c(0.5,max(coldend$xend)+0.5))+ 
            scale_y_continuous(expand=c(0,0))+
            theme_ggh()
    #cold
  }else{
    cold <- blank_grid
  }
  
  ##row dendrogram if needed
  if(RowV==T){
    rowdend <- as.dendrogram(clst_y)
    #plot(rowdend)
    rowdend <- segment(dendro_data(rowdend))
    rowd <- ggplot()+
            geom_segment(data = rowdend,aes(x=x, y=y, xend=xend, yend=yend))+
            scale_x_continuous(expand=c(0,0),limits = c(0.5,max(rowdend$xend)+0.5))+ 
            scale_y_reverse(expand=c(0,0))+
            theme_ggh()+
            coord_flip()
    #rowd
  }else{
    rowd <- blank_grid
  }
  
  ##key histgram(density plot)
  key_hist <- hist(tiledata$value,breaks = 50,plot = F)
  max_hist <- max(key_hist$density)
  key_density <- data.frame(range=seq(min(tiledata$value)-1, max(tiledata$value)+1, 0.02))
  key_density_range <- density(tiledata$value)
  
  key <-  ggplot()+
          geom_tile(data = key_density, 
                    mapping = aes(x = range, y=max_hist/2*1.2,fill=range,width=0.02, height=max_hist*1.2),
                    show.legend = F)+
          scale_fill_gradient2(low = colours[1],mid = colours[2],high = colours[3],
                               midpoint = (max(tiledata$value)+min(tiledata$value))/2,
                               limits=c(min(tiledata$value),max(tiledata$value)),
                               oob=squish)+
          scale_x_continuous(expand=c(0,0))+
          scale_y_continuous(expand=c(0,0))+
          geom_histogram(data = tiledata,mapping = aes(x=value,y=..density..),
                         alpha=0.8, binwidth = (max(tiledata$value)-min(tiledata$value))/50)+
          guides(fill=F,colour=F)+xlab("")+ylab("")+
          theme_classic()+
          theme(text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
                axis.text.x =  element_text(family = "Arial",size=key.axis.fontsize),
                axis.text.y =  element_text(family = "Arial",size=key.axis.fontsize),
                plot.margin = unit(c(0,0,-0.02,-0.015),"native"))
  #key
  
  ##colnames
  if(colname_label==T){
    colname_label <- ggplot()+
                geom_text(data=colname,mapping = aes(x=x,y=0, label=text,angle=colangle),
                          size=3,hjust=0)+
                scale_x_continuous(expand=c(0,0),limits = c(min(colname$x)-0.5, max(colname$x)+0.5))+
                scale_y_continuous(expand=c(0,0),limits = c(0,1))+
                theme_ggh(font.size =font.size)
    colname_table <- ggplot_gtable(ggplot_build(colname_label))
    colname_table$layout$clip[colname_table$layout$name=="panel"] <- "off"
    #class(colname_table)
    #colname_label
  }else{
    colname_label <- blank_grid
    colname_table <- blank_grid
  }
  
  ##rownames
  if(rowname_label==T){
    rowname_label <- ggplot()+
                geom_text(data = rowname,mapping = aes(x=0,y=y, label=text,angle=rowangle),
                          size=3,hjust=0)+
                scale_x_continuous(expand=c(0,0),limits = c(0,0.05))+
                scale_y_continuous(expand=c(0,0),limits = c(min(rowname$y)-0.5, max(rowname$y)+0.5))+
                theme_ggh(font.size =font.size)
    rowname_table <- ggplot_gtable(ggplot_build(rowname_label))
    rowname_table$layout$clip[rowname_table$layout$name=="panel"] <- "off"
    #rowname_label
  }else{
    rowname_label <- blank_grid
    rowname_table <- blank_grid
  }
  
  if(!is.null(add_p)){
    add <- add_p
  }else{
    add <- blank_grid
  }
  #add <- b1
  add <- rows_legend

  ##layout
  if(is.null(lmat) | is.null(lwid) | is.null(lhei)){
    lmat <- rbind(c(7,7,1,1,1,1),
                  c(7,7,5,1,1,1),
                  c(7,7,3,1,1,1),
                  c(6,4,2,9,10,1),
                  c(1,1,8,1,1,1))
    lwid <- c(0.2, 0.1, 1, 0.1,0.5,0.01)
    lhei <- c(0.1,0.2,0.1,2,0.01)
  }


  g1 <- grid.arrange(blank_grid,#1
                     p1,#2
                     cols,#3
                     rows,#4
                     cold,#5
                     rowd,#6
                     key,#7
                     colname_table,#8
                     rowname_table,#9
                     add,#10
                     layout_matrix=lmat,heights=lhei, widths=lwid,
                     top=textGrob(main, gp=gpar(fontsize=20,fontfamily="Arial")))
  result_list <- list(plot_data=g1, cluster_data=cluster_data)
  return(result_list)
}

```

##plot ggheat
```{r}
lmat <- rbind(c(7,7,1,1,1,1),
              c(7,7,5,1,1,1),
              c(7,7,3,1,1,1),
              c(6,4,2,9,10,1),
              c(1,1,8,1,1,1))
lwid <- c(0.2, 0.1, 1, 0.01,0.5,0.01)
lhei <- c(0.1,0.2,0.1,2,0.01)

ggheat(df = m,colslider = colslider,rowslider=rowslider)
res <- ggheat(df = t(m), colslider=rowslider ,rowslider=colslider, ColV = T,colname_label = F,font.size = 0.2)

res <- ggheat(df = t(m), colslider=rowslider ,rowslider=colslider, ColV = T,colname_label = F,rowname_label = F,font.size = 14,clst_method = "ward.D2",lmat=lmat, lwid=lwid, lhei = lhei,main = "")
grid.draw(res$plot_data)
ggsave(plot=res$plot_data,filename = "pca_clst2.tiff",dpi = 300,width = 18,height = 18,units = "cm")
grid.draw(res$plot_data)
res$cluster_data

```

##multi_detect function
```{r}
one2multi_detect <- function(target_vector, search_vector){
  require("stringr")
  result_bool_vector <- c()
  for (i in c(1:length(target_vector))){
    bool_j <- c()
    for (j in c(1:length(search_vector))){
      bool_j <- c(bool_j,
                  str_detect(string = target_vector[i],
                             pattern = search_vector[j]))
    }
    bool_i <- sum(bool_j != 0)
    result_bool_vector <- c(result_bool_vector, as.logical(bool_i))
  }
  return(result_bool_vector)
} 
```


##without ES, iPS, germ, Blood, Other cells
```{r}
out_words <- c("Blood", "ES_iPS_germ","Other")
limited_m <- m[,!one2multi_detect(colnames(m), out_words)]
limited_colslider <- colslider[!one2multi_detect(colslider,out_words)]

limited_res <- ggheat(df = t(limited_m), colslider=rowslider ,rowslider=limited_colslider, ColV = T,colname_label = F,rowname_label = F,font.size = 14,clst_method = "ward.D2",lmat=lmat, lwid=lwid, lhei = lhei,main = "")
grid.draw(limited_res$plot_data)
ggsave(plot=limited_res$plot_data,filename = "limited_pca_clst2.tiff",dpi = 300,width = 18,height = 18,units = "cm")
grid.draw(res$plot_data)
```

##custom palette from colorbrewer
http://colorbrewer2.org/#type=qualitative&scheme=Paired&n=10
```{r}
newcol <- c(A="#e31a1c",B="#1f78b4",C="#33a02c",
            Bone_soft="#fdbf6f",Fibroblasts="#ff7f00",Hepatocytes="#fb9a99",MSC="#a6cee3",
            Neuro_endo="#cab2d6",SMC="#6a3d9a",Vascular="#b2df8a")


limited_res <- ggheat(df = t(limited_m), colslider=rowslider ,rowslider=limited_colslider, ColV = T,colname_label = F,rowname_label = F,font.size = 14,clst_method = "ward.D2",lmat=lmat, lwid=lwid, lhei = lhei,main = "",rowslider_palette = newcol)
ggsave(plot = limited_res$plot_data, filename = "limited_heat_newcol.tiff",dpi = 300,width = 18,height = 18,units = "cm")
```



#re define DEG for cluster B cell lines
```{r}
q_value_cuttoff_re <- 0.001
deg_B <- annot[annot$q.value < q_value_cuttoff_re,]

out_words_B <- c("Blood", "ES_iPS_germ","Other","Hepatocytes", "_A_")

nnn <- mas5lg2[rownames(mas5lg2) %in% deg_B$Row.names,]
nnn <- nnn[ref_sort(sort_vector =  rownames(nnn),ref_vector = deg_B$Row.names),]
nnn <- nnn[,ref_sort(sort_vector = colnames(nnn),ref_vector = conv_mat$sample_tag)]
nnn <- nnn[,!one2multi_detect(colnames(nnn), out_words_B)]

nnn <- as.data.frame(nnn)


colslider_B <- conv_mat$category
colslider_B
colslider_B <- colslider_B[!one2multi_detect(colslider_B, out_words)]
colslider_B <- colslider_B[colslider_B!= "A"]
colslider_B <- colslider_B[colslider_B!= "Hepatocytes"]

tmp <- data.frame(colslider_B, colnames(nnn))
tmp

rowslider_B <- deg_B$gene_cluster

B_res_ward <- ggheat(df = t(nnn), colslider=rowslider_B ,rowslider=colslider_B, ColV = T,colname_label = F,rowname_label = F,font.size = 14,clst_method = "ward.D2",lmat=lmat, lwid=lwid, lhei = lhei,main = "")
grid.draw(B_res_ward$plot_data)

ggsave(plot=B_res_ward$plot_data,filename = "B_limited.tiff",dpi = 300,width = 18,height = 18,units = "cm")

B_res_avg <- ggheat(df = t(nnn), colslider=rowslider_B ,rowslider=colslider_B, ColV = T,colname_label = F,rowname_label = F,font.size = 14,clst_method = "average",lmat=lmat, lwid=lwid, lhei = lhei,main = "")


```

##stroma cell in stroma category...
```{r}
data_new_categ <- list()

categ3 <- list(Blood_cell=c("T_cell","T cell","T cells","CD4 cells","Treg","t_cell",
                            "Effector memory","Central memory","Naive, donor","B-cells",
                            "B cells","B cell","Monocyte","monocytes","monopcytes",
                            "Peripheral blood from healthy human donor",
                            "macrophages","Macrophages","Erythroblast",
                            "Bone marrow & progenitors","Myelocytes","MEP cells","GMP cells",
                            "CMP cells","HSC","Human composite bone marrow","peripheral blood, prior",
                            "Neutrophils","neutrophils","PMN","centrocyte","centroblast","platelet",
                            "NK cells","Natural killer cells","Natural Killer cells ",
                            "Dendritic cells","dendritic cells","MDDC","DCs","Dcs"),
              Stromal_cell=c("-defrived mesenchymal stem cells","BM MSC","BM-MSC",
                             "cell type: mesenchymal stem cells","derived mesenchymal stem cells",
                             "smooth muscle cells","Smooth Muscle Cells","SMCs","smooth muscle cell",
                             "Foreskin Cells","normal fibroblast","cell type: fibroblast",
                             "Human Fibroblast cells","PDB fibroblasts","fibroblasts_",
                             "Fibroblasts uninfected","Fibroblasts infected",
                             "osteoblast","chondrocyte","DPSCs","adipocyte","adipose stem cell"),
              Neuro_endo=c("Nerve","astrocytes","adrenal medulla"),
              Hepatocytes=c("hepatocyte"),
              Endothel=c("lymphatic endothelial cells","HUVEC","Vein ECs",
                         "blood vessel endothelial cell","HMVEC","cell type: Endothelial cells"),
              Other=c("bronchial epithelial cells","bladder","keratinocytes"),
              ES_iPS_germ=c("ESC","iPS","hIPSC","ES cell","Human Embryonic Stem Cells","embryonic stem cells","Sperm","Oocytes","oocytes")
              )

categ3_2 <- list(Blood_cell=c("T_cell","T cell","T cells","CD4 cells","Treg","t_cell",
                            "Effector memory","Central memory","Naive, donor","B-cells",
                            "B cells","B cell","Monocyte","monocytes","monopcytes",
                            "Peripheral blood from healthy human donor",
                            "macrophages","Macrophages","Erythroblast",
                            "Bone marrow & progenitors","Myelocytes","MEP cells","GMP cells",
                            "CMP cells","HSC","Human composite bone marrow","peripheral blood, prior",
                            "Neutrophils","neutrophils","PMN","centrocyte","centroblast","platelet",
                            "NK cells","Natural killer cells","Natural Killer cells ",
                            "Dendritic cells","dendritic cells","MDDC","DCs","Dcs"),
              Stromal_cell=c("-defrived mesenchymal stem cells","BM MSC","BM-MSC",
                             "cell type: mesenchymal stem cells","derived mesenchymal stem cells",
                             "smooth muscle cells","Smooth Muscle Cells","SMCs","smooth muscle cell",
                             "Foreskin Cells","normal fibroblast","cell type: fibroblast",
                             "Human Fibroblast cells","PDB fibroblasts","fibroblasts_",
                             "Fibroblasts uninfected","Fibroblasts infected",
                             "osteoblast","chondrocyte","DPSCs","adipocyte","adipose stem cell","Nerve"),
              Neuro=c("astrocytes","adrenal medulla"),
              Hepatocytes=c("hepatocyte"),
              Endothel=c("lymphatic endothelial cells","HUVEC","Vein ECs",
                         "blood vessel endothelial cell","HMVEC","cell type: Endothelial cells"),
              Other=c("bronchial epithelial cells","bladder","keratinocytes"),
              ES_iPS_germ=c("ESC","iPS","hIPSC","ES cell","Human Embryonic Stem Cells","embryonic stem cells","Sperm","Oocytes","oocytes")
              )

categ3_3 <- list(Blood_cell=c("T_cell","T cell","T cells","CD4 cells","Treg","t_cell",
                            "Effector memory","Central memory","Naive, donor","B-cells",
                            "B cells","B cell","Monocyte","monocytes","monopcytes",
                            "Peripheral blood from healthy human donor",
                            "macrophages","Macrophages","Erythroblast",
                            "Bone marrow & progenitors","Myelocytes","MEP cells","GMP cells",
                            "CMP cells","HSC","Human composite bone marrow","peripheral blood, prior",
                            "Neutrophils","neutrophils","PMN","centrocyte","centroblast","platelet",
                            "NK cells","Natural killer cells","Natural Killer cells ",
                            "Dendritic cells","dendritic cells","MDDC","DCs","Dcs"),
              Stromal_cell=c("-defrived mesenchymal stem cells","BM MSC","BM-MSC",
                             "cell type: mesenchymal stem cells","derived mesenchymal stem cells",
                             "smooth muscle cells","Smooth Muscle Cells","SMCs","smooth muscle cell",
                             "Foreskin Cells","normal fibroblast","cell type: fibroblast",
                             "Human Fibroblast cells","PDB fibroblasts","fibroblasts_",
                             "Fibroblasts uninfected","Fibroblasts infected",
                             "osteoblast","chondrocyte","DPSCs","adipocyte","adipose stem cell",
                             "Nerve","astrocytes"),
              Endocrine = c("adrenal medulla"),
              Hepatocytes=c("hepatocyte"),
              Endothel=c("lymphatic endothelial cells","HUVEC","Vein ECs",
                         "blood vessel endothelial cell","HMVEC","cell type: Endothelial cells"),
              Epithelial=c("bronchial epithelial cells","bladder","keratinocytes"),
              ES_iPS_germ=c("ESC","iPS","hIPSC","ES cell","Human Embryonic Stem Cells","embryonic stem cells","Sperm","Oocytes","oocytes")
              )



# data_new_categ[["categ3"]] <- categ3
data_new_categ[["categ3"]] <- categ3_3
  #append(data_new_categ, categ3=list(categ3))


sample_info <- data.frame(filename=cels,data_colname=data_colname,id=rowname_cands,stringsAsFactors = F)
sample_info <- merge(sample_info, result_df,by.x = "id", by.y = "geo_accession",sort = F,all.x = T)

sample_info$title <- ifelse(test = is.na(sample_info$title),yes = "",no = sample_info$title)
sample_info$source_name_ch1 <- ifelse(test = is.na(sample_info$source_name_ch1),
                                   yes = "",no = sample_info$source_name_ch1)
sample_info$characteristics_ch1 <- ifelse(test = is.na(sample_info$characteristics_ch1),
                                       yes = "",no = sample_info$characteristics_ch1)
sample_info$colname_tag <- base::paste(sample_info$id, sample_info$title)
sample_info$category <- categolizer(annotation_df = data.frame(sample_info$characteristics_ch1,
                                                   sample_info$source_name_ch1,
                                                   sample_info$title,stringsAsFactors = F),
                        dictionaly_list = data_new_categ$categ3)

sample_info$sample_tag <- paste(sample_info$category, sample_info$id, sep = "_")

sample_info$category <- ifelse(sample_info$category=="",str_extract(sample_info$colname_tag,"^[ABC]"),sample_info$category)

openxlsx::write.xlsx(x = sample_info, 
                     file = "sample_info.xlsx")

data_new_categ[["sample_info"]] <- sample_info


m_re <- log2(mas5_4each)
m_re <- m_re[rownames(m_re) %in% deg$Row.names,]

colnames_temp <- colnames(m_re)
colnames_temp <- str_replace_all(colnames_temp,pattern = "\\.cel\\.gz","")
colnames_temp <- str_replace_all(colnames_temp,pattern = "\\.cel|\\.CEL","")

colnametemp <- for(i in c(1:length(colnames_temp))){
  if(str_detect(colnames_temp[i],"^[ABC]")){
    colnames_temp[i] <- colnames_temp[i]
  }
  else if(str_detect(colnames_temp[i], "^GSM")){
    colnames_temp[i] <- str_extract(colnames_temp[i], "^GSM[0-9]*")
  }
  else{
    print("unknown condition")
  }
}

#colnames_temp
#conv_mat$id
#colnames_temp[!colnames_temp %in% conv_mat$id]

#matrix_in_out = data.frame(conv_mat$id,conv_mat$sample_tag)

colnames_temp <- convertvector(inputvector = colnames_temp,
                                         matrix_in_out = data.frame(sample_info$id,                                                                    sample_info$sample_tag,stringsAsFactors = F))

colnames(m_re) <- colnames_temp
rm(colnames_temp)


m_re <- m_re[ref_sort(sort_vector =  rownames(m_re),ref_vector = deg$Row.names),]
m_re <- m_re[,ref_sort(sort_vector = colnames(m_re),ref_vector = data_new_categ$sample_info$sample_tag)]

# sum(colnames(m_re) %in% sample_info$sample_tag)
# colnames(m_re)[!colnames(m_re) %in% sample_info$sample_tag]
# table(sample_info$category)

data_new_categ[["matrix"]] <- t(m_re)

table(data_new_categ$sample_info$category)

data_new_categ[["rowslider"]] <- data_new_categ$sample_info$category
data_new_categ[["colslider"]] <- deg$gene_cluster

newcol2 <- c(A="#e31a1c",B="#1f78b4",C="#33a02c",
            Epithelial="#fdbf6f",Stromal_cell="#6a3d9a",Hepatocytes="#ff7f00",Endothel="#a6cee3",
            Endocrine="#cab2d6",ES_iPS_germ="#fb9a99",Blood_cell="#b2df8a")


lmat <- rbind(c(7,7,1,1,1,1),
              c(7,7,5,1,1,1),
              c(7,7,3,1,1,1),
              c(6,4,2,9,10,1),
              c(1,1,8,1,1,1))
lwid <- c(0.25, 0.1, 1, 0.01,0.5,0.01)
lhei <- c(0.1,0.2,0.1,2,0.01)




gh_new <- ggheat(df = data_new_categ$matrix,clst_method = "ward.D2",dist_method = "spearman",colslider = data_new_categ$colslider, rowslider = data_new_categ$rowslider,colname_label = F, rowname_label = F,rowslider_palette = newcol2,main = "",lmat = lmat, lwid = lwid,lhei = lhei,font.size = 14)
grid.draw(gh_new$plot_data)

# ggsave(plot = gh_new$plot_data,filename = "ggheat_stroma_emph.tiff",dpi = 300,width = 18,height = 18,units = "cm")
ggsave(plot = gh_new$plot_data,filename = "ggheat_stroma_emph_mod.tiff",dpi = 300,width = 18,height = 18,units = "cm")
```

```{r}
# c_res <- gh_new$cluster_data
# clst_y <- c_res[[2]] 
# clst_y_df <- data.frame(label=clst_y[["labels"]],
#              order=clst_y[["order"]])
# clst_y["labels"]
# clst_y["order"]

```


##ggheat2
```{r}
# df = t(m)
# colslider= data_new_categ$colslider
# rowslider=data_new_categ$rowslider
# ColV = T
# colname_label = F
# font.size = 1
#                    clst_method="average"
#                    dist_method="spearman"

ggheat2 <- function(df,
                   clst_method="average",
                   dist_method="spearman",
                   colslider, rowslider,
                   ColV=T, RowV=T,
                   colname_label=T, rowname_label=T,
                   colangle=45, rowangle=45,
                   colours=c("blue", "white", "red"),
                   key.axis.fontsize=12,
                   main="title",
                   add_p=NULL,
                   add_p2=NULL,
                   lmat=NULL,
                   lhei=NULL,lwid=NULL,
                   font.size=10,
                   rowslider_palette=NULL,
                   rowslider_palette_order=NULL){
  require(ggplot2)
  require(reshape2)##for melting
  require(grid)
  require(gridExtra)
  require(ggdendro)
  require(scales)
  ##common theme function
  theme_ggh <- function(font.size=10,legend.position = "none") {
              theme(axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              axis.title = element_blank(),
              axis.line = element_blank(),
              axis.ticks = element_blank(),
              plot.title = element_blank(),
              panel.grid = element_blank(),
              panel.border = element_blank(),
              panel.spacing = element_blank(),
              panel.background = element_blank(),
              plot.background = element_blank(),
              plot.margin = unit(c(0,0,0,0),"cm"),
              text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
              legend.position = "none"
)
  }
  
  ##blank grid for plotting blank
  blank_grid <- grid.rect(gp=gpar(col="white"))

  df <- as.data.frame(df)
  
  ##clustering if needed
  cluster_data <- list()
  if(ColV==T){
     dist_x <- as.dist(1-cor(as.matrix(df),method = dist_method))
     clst_x <- hclust(dist_x,method = clst_method)
     df <- df[,clst_x$order]
     colslider <- colslider[clst_x$order]
     cluster_data <- append(cluster_data, list(clst_x))
  }
  
  if(RowV==T){
     dist_y <- as.dist(1-cor(as.matrix(t(df)),method = dist_method))
     clst_y <- hclust(dist_y,method = clst_method)
     df <- df[clst_y$order,]
     rowslider <- rowslider[clst_y$order]
     cluster_data <- append(cluster_data, list(clst_y))
  }
  
  df4out <- df
  
  ##matrix prepareation
  colname <- colnames(df)
  colname <- data.frame(text=colname, x=c(1:length(colname)),colslider=colslider)
  colnames(df) <- c(1:ncol(df))
  
  rowname <- rownames(df)
  rowname <- data.frame(text=rowname, y=c(1:length(rowname)),rowslider=rowslider)
  rownames(df) <- c(1:nrow(df))
  
  ##for rowname_order
  rowname[,3] <- factor(x = rowslider, levels = c("A", "Hepatocytes", "B","Stromal_cell", "C", "Blood_cell", "Endothel", "ES_iPS_germ","Endocrine", "Epithelial"))
  ##
  
  
  tiledata <- melt(as.matrix(df))
  
  ##heatmap is p1
  p1 <- ggplot()+
        geom_tile(data = tiledata, mapping = aes(x=Var2, y = Var1, fill=value))+
        scale_x_continuous(expand=c(0,0))+ 
        scale_y_continuous(expand=c(0,0))+
        scale_fill_gradient2(low = colours[1],mid = colours[2],high = colours[3],midpoint = (max(tiledata$value)+min(tiledata$value))/2)+
        guides(fill=F)+
        theme_ggh()
  #p1

  ##colslider is cols
  cols <- ggplot()+
          geom_tile(data=colname,aes(x=x,y=0,fill=colslider))+
          scale_x_continuous(expand=c(0,0))+ 
          scale_y_continuous(expand=c(0,0))+
          theme_ggh()
##          scale_fill_identity(guide = "legend")+
          
  #cols
  
  
  if(!is.null(rowslider_palette)){
    add_fill <- function(){return(scale_fill_manual(values = rowslider_palette,name="category"))}
  }else{
    add_fill <- function(){return(scale_fill_discrete(name="category"))}
  }
  ##rowslider is rows
  rows <- ggplot()+
          geom_tile(data=rowname,aes(x=0,y=y,fill=rowslider))+
          scale_x_continuous(expand=c(0,0))+ 
          scale_y_continuous(expand=c(0,0))+
          add_fill()+
          theme(legend.text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
                legend.title =element_text(family = "Arial",size=font.size+2,lineheight = 0.7))
  
  rows_grob <- ggplot_gtable(ggplot_build(rows))
  id.legend <- which(sapply(rows_grob$grobs, function(x) x$name)=="guide-box")
  rows_legend <- rows_grob$grobs[[id.legend]]
  
  rows <- ggplot()+
          geom_tile(data=rowname,aes(x=0,y=y,fill=rowslider))+
          scale_x_continuous(expand=c(0,0))+ 
          scale_y_continuous(expand=c(0,0))+
          add_fill()+
          theme_ggh()
  #rows
  
  ##col dendrogram if needed
  if(ColV==T){
    coldend <- as.dendrogram(clst_x)
    #plot(coldend)
    coldend <- segment(dendro_data(coldend))
    cold <- ggplot()+
            geom_segment(data=coldend,aes(x=x, y=y, xend=xend, yend=yend))+
            scale_x_continuous(expand=c(0,0),limits = c(0.5,max(coldend$xend)+0.5))+ 
            scale_y_continuous(expand=c(0,0))+
            theme_ggh()
    #cold
  }else{
    cold <- blank_grid
  }
  
  ##row dendrogram if needed
  if(RowV==T){
    rowdend <- as.dendrogram(clst_y)
    #plot(rowdend)
    rowdend <- segment(dendro_data(rowdend))
    rowd <- ggplot()+
            geom_segment(data = rowdend,aes(x=x, y=y, xend=xend, yend=yend))+
            scale_x_continuous(expand=c(0,0),limits = c(0.5,max(rowdend$xend)+0.5))+ 
            scale_y_reverse(expand=c(0,0))+
            theme_ggh()+
            coord_flip()
    #rowd
  }else{
    rowd <- blank_grid
  }
  
  ##key histgram(density plot)
  key_hist <- hist(tiledata$value,breaks = 50,plot = F)
  max_hist <- max(key_hist$density)
  key_density <- data.frame(range=seq(min(tiledata$value)-1, max(tiledata$value)+1, 0.02))
  key_density_range <- density(tiledata$value)
  
  key <-  ggplot()+
          geom_tile(data = key_density, 
                    mapping = aes(x = range, y=max_hist/2*1.2,fill=range,width=0.02, height=max_hist*1.2),
                    show.legend = F)+
          scale_fill_gradient2(low = colours[1],mid = colours[2],high = colours[3],
                               midpoint = (max(tiledata$value)+min(tiledata$value))/2,
                               limits=c(min(tiledata$value),max(tiledata$value)),
                               oob=squish)+
          scale_x_continuous(expand=c(0,0))+
          scale_y_continuous(expand=c(0,0))+
          geom_histogram(data = tiledata,mapping = aes(x=value,y=..density..),
                         alpha=0.8, binwidth = (max(tiledata$value)-min(tiledata$value))/50)+
          guides(fill=F,colour=F)+xlab("")+ylab("")+
          theme_classic()+
          theme(text = element_text(family = "Arial",size=font.size,lineheight = 0.7),
                axis.text.x =  element_text(family = "Arial",size=key.axis.fontsize),
                axis.text.y =  element_text(family = "Arial",size=key.axis.fontsize),
                plot.margin = unit(c(0,0,-0.02,-0.015),"native"))
  #key
  
  ##colnames
  if(colname_label==T){
    colname_label <- ggplot()+
                geom_text(data=colname,mapping = aes(x=x,y=0, label=text,angle=colangle),
                          size=3,hjust=0)+
                scale_x_continuous(expand=c(0,0),limits = c(min(colname$x)-0.5, max(colname$x)+0.5))+
                scale_y_continuous(expand=c(0,0),limits = c(0,1))+
                theme_ggh(font.size =font.size)
    colname_table <- ggplot_gtable(ggplot_build(colname_label))
    colname_table$layout$clip[colname_table$layout$name=="panel"] <- "off"
    #class(colname_table)
    #colname_label
  }else{
    colname_label <- blank_grid
    colname_table <- blank_grid
  }
  
  ##rownames
  if(rowname_label==T){
    rowname_label <- ggplot()+
                geom_text(data = rowname,mapping = aes(x=0,y=y, label=text,angle=rowangle),
                          size=3,hjust=0)+
                scale_x_continuous(expand=c(0,0),limits = c(0,0.05))+
                scale_y_continuous(expand=c(0,0),limits = c(min(rowname$y)-0.5, max(rowname$y)+0.5))+
                theme_ggh(font.size =font.size)
    rowname_table <- ggplot_gtable(ggplot_build(rowname_label))
    rowname_table$layout$clip[rowname_table$layout$name=="panel"] <- "off"
    #rowname_label
  }else{
    rowname_label <- blank_grid
    rowname_table <- blank_grid
  }
  
  if(!is.null(add_p)){
    add <- add_p
  }else{
    add <- blank_grid
  }
  #add <- b1
  add <- rows_legend

  
  if(is.null(add_p2)){
    add_p2 <- blank_grid
  }
  
  ##layout
  if(is.null(lmat) | is.null(lwid) | is.null(lhei)){
    lmat <- rbind(c(7,7,1,1,1,11),
                  c(7,7,5,1,1,1),
                  c(7,7,3,1,1,1),
                  c(6,4,2,9,10,1),
                  c(1,1,8,1,1,1))
    lwid <- c(0.2, 0.1, 1, 0.1,0.5,0.01)
    lhei <- c(0.1,0.2,0.1,2,0.01)
  }


  g1 <- grid.arrange(blank_grid,#1
                     p1,#2
                     cols,#3
                     rows,#4
                     cold,#5
                     rowd,#6
                     key,#7
                     colname_table,#8
                     rowname_table,#9
                     add,#10
                     add_p2,#11
                     layout_matrix=lmat,heights=lhei, widths=lwid,
                     top=textGrob(main, gp=gpar(fontsize=20,fontfamily="Arial")))
  result_list <- list(plot_data=g1, cluster_data=cluster_data)
  result_list$df <- df4out
  result_list$tiledate <- tiledata
  result_list$rn <- rowname
  result_list$cn <- colname
  return(result_list)
}

```

##get custer data
```{r}
row_clst <- gh_new$cluster_data[2][[1]]
# row_clst$order[str_detect(row_clst$labels,pattern = "Stroma_cell|_B_")]
# row_clst$labels[row_clst$order]
# row_clst$order
# cutree(row_clst, k = 10)
row_clst_df <- data.frame(1:length(row_clst$order),row_clst$order, row_clst$labels,row_clst$labels[row_clst$order],cutree(row_clst, k = 10)[row_clst$order])
row_clst_df
range2 <- range(row_clst_df[row_clst_df$"cutree.row_clst..k...10..row_clst.order."=="2",]$"X1.length.row_clst.order.")
range10 <- range(row_clst_df[row_clst_df$"cutree.row_clst..k...10..row_clst.order."=="10",]$"X1.length.row_clst.order.")

arrow_t_length <- 0.5
arrow_width <- 1
add_p <- ggplot()+
  annotate("segment",x=range2[1], xend = range2[2]-1,y = 0, yend = 0, arrow=arrow(ends = "both", angle = 90,length = unit(arrow_t_length, "cm")),color="blue",size=arrow_width)+
  annotate("segment",x=range10[1]+1, xend = range10[2],y = 0, yend = 0, arrow=arrow(ends = "both", angle = 90,length = unit(arrow_t_length, "cm")),color="red",size=arrow_width)+
  coord_flip()+
  scale_x_continuous(expand=c(0,0), limits = c(1,741))+
  theme_ggh()

add_p
```


```{r}
col_mod <- function(chr,sub = -32){
    is.color <- function(chr){
        res <- try(col2rgb(chr), silent = TRUE)
        return(!"try-error"%in%class(res))
    }
    if(is.color(chr)){
        color_in <- col2rgb(chr)
        color_in <- color_in + sub
        color_in <- ifelse(color_in >= 255, 255, color_in)
        color_in <- ifelse(color_in <= 0, 0, color_in)
        color_out <- as.hexmode(color_in)
        color_out <- as.character(color_out)
        color_out <- paste("#",
                           color_out[1],color_out[2],color_out[3],sep = "")
        return(color_out)
    }else{
        return("black")
    }
}

# 
# newcol3 <- c(A="#e31a1c",B="#1f78b4",C="#33a02c",
#             Stromal_cell="#6a3d9a",Hepatocytes="#ff7f00",Endothel="#a6cee3",Epithelial="#fdbf6f",
#             Endocrine="#cab2d6",ES_iPS_germ="#fb9a99",Blood_cell="#b2df8a")
newcol3 <- c(A="#e31a1c",B="#1f78b4",C="#33a02c",
            Stromal_cell="#6a3d9a",Hepatocytes="#ff7f00",Endothel="#a6cee3",Epithelial="#a6a6a6",
            Endocrine="#cab2d6",ES_iPS_germ="#fb9a99",Blood_cell="#b2df8a")
newcol3[1:5] <- sapply(newcol3[1:5], col_mod, -16)
newcol3[6:10] <- sapply(newcol3[6:10], col_mod, +32)
newcol3
df_temp <- data_new_categ$matrix

```


```{r}
lmat <- rbind(c(7,7,7,1,1,1,1),
              c(7,7,7,5,1,1,1),
              c(7,7,7,3,1,1,1),
              c(1,6,4,2,11,10,9),
              c(1,1,1,8,1,1,1))
lwid <- c(0.1,0.2, 0.08, 1, 0.08,0.45,0.01)
lhei <- c(0.1,0.2,0.1,2,0.01)
newcol3
base::saveRDS(newcol3, "./setting_newcol3.rds")
data_new_categ$rowslider

gh_new2 <- ggheat2(df = data_new_categ$matrix,clst_method = "ward.D2",dist_method = "spearman",colslider = data_new_categ$colslider, rowslider = data_new_categ$rowslider,colname_label = F, rowname_label = F,rowslider_palette = newcol3,main = "",lmat = lmat, lwid = lwid,lhei = lhei,font.size = 14,add_p2 = add_p)
grid.draw(gh_new2$plot_data)

ggsave(plot = gh_new2$plot_data,filename = "ggheat_stroma_emph2_mod.tiff",dpi = 300,width = 18,height = 18,units = "cm")
ggsave(plot = gh_new2$plot_data,filename = "R_137ggheat_stroma_emph2_mod.tiff",dpi = 300,width = 18,height = 18,units = "cm")
#ggsave(plot = gh_new2$plot_data,filename = "ggheat_stroma_emph2_high_res.tiff",dpi = 900,width = 18,height = 18,units = "cm")
```


```{r}
df4out <- gh_new2$df %>%
  .[rev(1:nrow(.)),]

for(i in 1:ncol(df4out)){
  df4out[[i]] <- as.character(df4out[[i]])
}

clstx <- gh_new2$rn %>%
  dplyr::select(-y) %>%
  `colnames<-`(c("tag", "category"))

clsty <- gh_new2$cn %>%
  dplyr::select(-x) %>%
  t() %>%
  as.data.frame() %>%
  `colnames<-`(.[1,] %>%
  unlist() %>%
  as.character()
  ) %>%
  as.data.frame() %>%
  `rownames<-`(c("probesetid", "geneclass")) %>%
  .[2,]
# clsty[1,] %>%
#   unlist() %>%
#   as.character()
  
# sum(clsty$text != colnames(df4out))
df4out_bind <- dplyr::bind_rows(clsty,
                                df4out) %>%
  merge(x=., y= clstx, by.x=0, by.y="tag", all.x=T, sort=F) %>%
  dplyr::rename(sample_tag = "Row.names") %>%
  dplyr::select(category, sample_tag,  everything()) %>%
  .[c(nrow(.), 1:nrow(.)-1),]

openxlsx::write.xlsx(x=df4out_bind, "./R137_pca_and_livercelllines_clustering.xlsx", rowNames = F, colNames=T) 
```

##get PCA deposited data
```{r}
#downloader::download(url = "http://www.macrophages.com/sites/default/files/repbiolayoutdatasets/Human_primary_cell_atlas.expression.zip",destfile="pca.zip")
#unzip("./pca.zip")
PCatlas <- read.table(file = "./Human_primary_cell_atlas.expression",header = T,sep = "\t",stringsAsFactors = F,quote = "")
```


```{r}
categ4 <- list(Tcell=c("T_cell","T cell","T cells","CD4 cells","Treg","t_cell","Effector memory","Central memory","Naive, donor"),
              Bcell=c("B-cells","B cells","B cell"),
              Mono_Macro = c("cell type: Monocyte","monocytes","monopcytes","Peripheral blood from healthy human donor","macrophages","Macrophages"),
              Erythroblast = c("Erythroblast"),
              BM_HSC =c("Bone marrow & progenitors","Myelocytes","MEP cells","GMP cells","CMP cells",
                        "HSC","Human composite bone marrow","peripheral blood, prior"),
              Neutrophils=c("Neutrophils","neutrophils","PMN"),
              Gametes=c("Sperm","Oocytes","oocytes"),
              Centrocytes=c("centrocyte","centroblast"),
              NKcells=c("NK cells","Natural killer cells","Natural Killer cells "),
              Dendritic_cells=c("Dendritic cells","dendritic cells","MDDC","DCs","Dcs"),
              MSC=c("-defrived mesenchymal stem cells","BM MSC","BM-MSC","cell type: mesenchymal stem cells","derived mesenchymal stem cells"),
              Plt=c("platelet"),
              SMC=c("smooth muscle cells","Smooth Muscle Cells","SMCs","smooth muscle cell"),
              Neuron=c("Nerve","astrocytes"),
              Endocrine=c("adrenal medulla"),
              Keratinocytes=c("keratinocytes"),
              Hepatocytes=c("hepatocyte"),
              Bone_etc=c("osteoblast","chondrocyte","DPSCs"),
              Adipocytes=c("adipocyte","adipose stem cell"),
              Vascular=c("lymphatic endothelial cells","HUVEC","Vein ECs","blood vessel endothelial cell","HMVEC","cell type: Endothelial cells"),
              Fibroblasts=c("Foreskin Cells","normal fibroblast","cell type: fibroblast","Human Fibroblast cells","PDB fibroblasts","fibroblasts_","Fibroblasts uninfected","Fibroblasts infected"),
              Epitel=c("bronchial epithelial cells"),
              Bladder=c("bladder"),
              ES_iPS = c("ESC", "ES cell","Human Embryonic Stem Cells","embryonic stem cells","iPS","hIPSC")
              )
```


```{r}
mat4cor <-  data.frame(filename=cels,data_colname=data_colname,id=rowname_cands,stringsAsFactors = F)

#label_vector <- c("nn", "daw", "dafb", "nn","daw","dafb", "nn")


calc_categ <- function(proc_matrix, label_vector, func="mean"){
  require(magrittr)
  
  proc_matrix <- proc_matrix %>%
    as.data.frame()
  
  labels_uniq <- label_vector[!duplicated(label_vector)]
  

  
  if(func=="mean"){
    fun <- function(x){base::mean(x)}
  }else if(func=="median"){
    fun <- function(x){stats::median(x)}
  }else{
    return("func is mean or median")
  }
  
  proc_result <- NULL
  
  for(i in 1:length(labels_uniq)){
    matrix_lab_i <- proc_matrix[,label_vector==labels_uniq[i]]
    proc_i <- apply(matrix_lab_i, 1, fun)
    
    proc_result <- cbind(proc_result, proc_i)
  }
  
  colnames(proc_result) <- labels_uniq
  return(proc_result)
}

```


```{r}
mat4cor <- merge(mat4cor, result_df,by.x = "id", by.y = "geo_accession",sort = F,all.x = T)

mat4cor$title <- ifelse(test = is.na(mat4cor$title),yes = "",no = mat4cor$title)
mat4cor$source_name_ch1 <- ifelse(test = is.na(mat4cor$source_name_ch1),
                                   yes = "",no = mat4cor$source_name_ch1)
mat4cor$characteristics_ch1 <- ifelse(test = is.na(mat4cor$characteristics_ch1),
                                       yes = "",no = mat4cor$characteristics_ch1)
mat4cor$colname_tag <- base::paste(mat4cor$id, mat4cor$title)
mat4cor$category <- categolizer(annotation_df = data.frame(mat4cor$characteristics_ch1,
                                                   mat4cor$source_name_ch1,
                                                   mat4cor$title,stringsAsFactors = F),
                        dictionaly_list = categ4)

mat4cor$sample_tag <- paste(mat4cor$category, mat4cor$id, sep = "_")
mat4cor$sample_tag <- str_replace(mat4cor$sample_tag, "^_","")

mat4cor$category <- ifelse(mat4cor$category=="Mono_Macro_Dendritic_cells", yes="Mono_Macro", no=mat4cor$category)

mat4cor$category <- ifelse(mat4cor$category=="",str_extract(mat4cor$colname_tag,"^[ABC]"),mat4cor$category)
```


```{r}
write.table(x = mat4cor,file = "matrix4cor_analysis.tsv",sep = "\t",col.names = NA,row.names = T)
openxlsx::write.xlsx(mat4cor, file = "matrix4cor_analysis.xlsx")
```



```{r}
mat4anal <- log2(mas5_4each)
#mat4anal <- mas5_4each

truehist(as.matrix(mat4anal))

colnames_temp <- colnames(mat4anal)
colnames_temp <- str_replace_all(colnames_temp,pattern = "\\.cel\\.gz","")
colnames_temp <- str_replace_all(colnames_temp,pattern = "\\.cel|\\.CEL","")

colnametemp <- for(i in c(1:length(colnames_temp))){
  if(str_detect(colnames_temp[i],"^[ABC]")){
    colnames_temp[i] <- colnames_temp[i]
  }
  else if(str_detect(colnames_temp[i], "^GSM")){
    colnames_temp[i] <- str_extract(colnames_temp[i], "^GSM[0-9]*")
  }
  else{
    print("unknown condition")
  }
}

#colnames_temp
#conv_mat$id
#colnames_temp[!colnames_temp %in% conv_mat$id]

#matrix_in_out = data.frame(conv_mat$id,conv_mat$sample_tag)


colnames_temp <- convertvector(inputvector = colnames_temp,
                               matrix_in_out = data.frame(mat4cor$id,
                                                          mat4cor$sample_tag,stringsAsFactors = F))

colnames(mat4anal) <- colnames_temp

rm(colnames_temp)
```

```{r writeingxx}
mat4anal <- mat4anal[,ref_sort(sort_vector = colnames(mat4anal),ref_vector = mat4cor$sample_tag)]

logical_center <- calc_categ(proc_matrix = mat4anal,label_vector = mat4cor$category,func = "median")

#logical_center <- logical_center[sort.list(apply(logical_center,1,mad)) <= 10000,]

truehist(apply(logical_center, 1, mad))

n <- mat4anal %>%
  .[sort.list(apply(.,1,mad)) <=  5000,]


truehist(apply(n, 1, mad))

#logical_center <- calc_categ(proc_matrix = n,label_vector = mat4cor$category,func = "median")


cors1 <- as.data.frame(cor(logical_center, method = "spearman")) %>%
  .[sort.list(.$B,decreasing = T),]


truehist(as.matrix(cors1))

write.csv(cors1, file = "category_cor.csv")

write.table(logical_center, file = "logical_center.tsv",sep = "\t",col.names = NA, row.names = T)
```

```{r}
#mat4cor$category
sum(mat4cor$category=="Fibroblasts")
```


##output annotation data and exprsdata
```{r}
#mas5 data
write.table(file = "mas5exprs.tsv",x = mas5_4each,sep = "\t",row.names = T, col.names = NA)
# write.table(file="rob_exprs.tsv",x=rob_4each, sep="\t", row.names = T, col.names = NA)
```



##dict4
```{r}
dict4out <- NULL

dict_label <- names(categ4)
for(i in 1:length(dict_label)){
  name_i <- paste(categ4[[dict_label[i]]], collapse=",")
  print(name_i)
  dict4out <- rbind(dict4out, name_i)
  rownames(dict4out)[i] <- dict_label[i]
}

write.table(dict4out, file = "categ4.tsv",sep = "\t",row.names = T, col.names = NA)

```


##sessioninfo
```{r}
sessionInfo()
Sys.time()
Sys.info()
```


